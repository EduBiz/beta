MB.campaign={};MB.adGroup={};MB.creative={};MB.campaign.search=function(){return{init:function(){if(!Ext.get("search_input")){return false}var b=new Ext.data.HttpProxy({url:MB.constant.base_control+"campaigns/search/ajax_query/"});var c=new Ext.data.Store({proxy:b,reader:new Ext.data.JsonReader({root:"rows",totalProperty:"results",id:"id"},[{name:"id",mapping:"id"},{name:"link",mapping:"link"},{name:"type",mapping:"type"},{name:"name",mapping:"name"}]),listeners:{load:function(e){e.insert(0,new Ext.data.Record({id:"1",link:MB.constant.base_control+"campaigns/search/?q="+escape(e.baseParams.q),name:"_full_text_search_"}))}}});var d=new Ext.XTemplate('<tpl for=".">','<div class="search-item <tpl if="this.isFullText(name)">full-search-item</tpl>" <tpl if="this.isFullText(name)">style="border: 0"</tpl>>','<h3><span class="{type}">{[values.name.length > 30 ? (values.name.substr(0, 29) + "...") : values.name]}</span></h3>',"</div>","</tpl>",{isFullText:function(e){return e=="_full_text_search_"}});var a=new Ext.form.ComboBox({store:c,displayField:"name",typeAhead:false,loadingText:_("Searching..."),width:160,queryDelay:300,minChars:3,hideTrigger:true,tpl:d,applyTo:"search_input",itemSelector:"div.search-item",queryParam:"q",onSelect:function(e){window.location=e.data.link},listeners:{specialkey:function(g,h){if(h.getKey(Ext.EventObject.ENTER)){h.stopEvent();window.location=MB.constant.base_control+"campaigns/search/?q="+escape(this.getValue())}}}})}}}();MB.campaign.list=function(){var b=null;var e={campaign_copy:{tpl:function(){return new Ext.XTemplate('<h2 style="margin-top: 0" class="campaign titleUnderline">',_("Copy Campaign:")," {name}</h2> ",'<form action="',MB.constant.base_control,'campaigns/action/copy_campaign" method="POST">','<input type="hidden" name="campaign_id" value="{ext_id}">',"<p>",_("To copy an existing campaign, enter a <b>New Campaign Name</b> then select which <b>Ad Groups to Copy</b>."),"</p><br><b>",_("New Campaign Name"),':</b> <input type="text" value="{copy_name}" size="50" name="name">',"<br><br><b>",_("Select Ad Groups to Copy:"),"</b>",'<div class="copyAdvancedDetails moduleTiny" id="copy-advanced-details">','<input type="hidden" name="deep_copy_ad_groups" value="1">','<input type="hidden" name="copy_all_ads" value="1">','<img src="',MB.constant.base_url,'img/spinner.gif" />',"</div>","<div class='moduleTiny' style='text-align: center'><div class='mbButton'><input type='submit' value='",_("Copy Campaign"),"&raquo;' id='submit' name='submit'/></div>","&nbsp;&nbsp;&nbsp;&nbsp;<a href='#' id='cancel_link'>",_("cancel"),'</a>&nbsp;<img id="modal_spinner" src="',MB.constant.base_url,'img/spinner.gif" style="visibility: hidden"></div>','<input type="hidden" value="',MB.constant.token,'" name="',MB.constant.token_name,'" />',"</form>")},cb:function(f){f.child("div.mbButton").addClassOnOver("mbButtonOver");f.child("input[name=name]").focus();var g=MB.constant.base_control+"campaigns/"+f.child("input[name=campaign_id]").getValue()+"/ajax_view";Ext.Ajax.request({url:g,success:function(j){var h=Ext.decode(j.responseText);var k=[];if(h.length){var i=0;k.push({tag:"li",html:'<input type="checkbox" checked="checked" id="copy_all_ad_groups"> <label for="copy_all_ad_groups">'+_("Select All")+"</label>"});Ext.each(h,function(l){i+=parseInt(l.count);k.push({tag:"li",cls:"sub",html:'<input type="checkbox" class="adgroup_checkbox" checked="checked" name="ad_group_id[]" rel="'+l.count+'" value="'+l.ext_id+'" id="ad_group_id_'+l.ext_id+'"> <label class="adgroup" for="ad_group_id_'+l.ext_id+'">'+l.name+' <span class="ad_group_ad_count" style="display:none; color:gray;">('+l.count+" creatives)</span></label><br>"})});Ext.DomHelper.overwrite("copy-advanced-details",[{tag:"ul",cls:"copyOptions",children:k}]);Ext.get("copy-advanced-details").insertHtml("beforeEnd",'<br><input type="checkbox" name="copy_all_ads"'+(i>remaining_creatives?"disabled='disabled'":'checked="checked"')+' value="1" id="copy_all_ads" class="adgroup_checkbox"> <label class="ad" for="copy_all_ads">'+_("Copy all ads for selected ad groups.")+'</label> <span id="creativecount_message" style="display:none; color:gray;">You can copy up to '+remaining_creatives+" total creative(s).</span>");Ext.select("input[name*=ad_group_id]").on("click",function(){Ext.get("copy_all_ad_groups").dom.checked=false});Ext.get("copy_all_ad_groups").on("click",function(m,l){Ext.each(Ext.query("input[name*=ad_group_id]"),function(n){n.checked=l.checked})});if(i>remaining_creatives){Ext.get("creativecount_message").show();Ext.each(Ext.query(".ad_group_ad_count"),function(l){Ext.get(l).show()});Ext.each(Ext.query(".adgroup_checkbox"),function(l){l=Ext.get(l);l.on("click",function(o,p,m){var n=0;Ext.each(Ext.query(".adgroup_checkbox:checked"),function(q){n+=parseInt(q.getAttribute("rel"))});if(n>remaining_creatives){Ext.get("copy_all_ads").dom.disabled=true;Ext.get("copy_all_ads").dom.checked=false}else{Ext.get("copy_all_ads").dom.disabled=false}})})}}else{Ext.DomHelper.overwrite("copy-advanced-details",[_("No Ad Groups found")])}}})}},campaign_copy_across:{tpl:function(){return new Ext.XTemplate('<h2 style="margin-top: 0" class="campaign titleUnderline">Copy Campaign Across Account: {name}</h2> ','<form action="',MB.constant.base_control,'campaigns/action/copy_campaign" method="POST">','<input type="hidden" name="across" value="true">','<input type="hidden" name="campaign_id" value="{ext_id}">',"<p>Please type in the exact <b>email</b> of an account to copy this campaign to. Target accounts must also be Full Serve enabled.</p><br>",'<p class="accountSearchError" style="display: none"><img align="top" src="',MB.constant.base_url+'img/icons/error.gif"> Account not found or account is not full serve enabled.</p>','<p class="accountSearch"><b>Target Account Email:</b> <input type="text" value="" size="50" name="account_search"> <button>Select</button></p>','<p class="accountLock" style="display: none"><b>Target Account Email:</b> <span></span> <img src="',MB.constant.base_url+'img/icons/tick.gif"><input type="hidden" name="target_user_id" id="target_user_id"><br><br></p>','<div class="restForm" style="display: none">','<p><b>New Campaign Name:</b> <input type="text" value="{copy_name}" size="50" name="name"></p>',"<br><br><b>",_("Select Ad Groups to Copy:"),"</b>",'<div class="copyAdvancedDetails moduleTiny" id="copy-advanced-details">','<input type="hidden" name="deep_copy_ad_groups" value="1">','<input type="hidden" name="copy_all_ads" value="1">','<img src="',MB.constant.base_url,'img/spinner.gif" />',"</div>","</div>","<div class='moduleTiny' style='text-align: center'><div class='mbButton'><input disabled='disabled' type='submit' value='",_("Copy Campaign"),"&raquo;' id='submit' name='submit'/></div>","&nbsp;&nbsp;&nbsp;&nbsp;<a href='#' id='cancel_link'>",_("cancel"),'</a>&nbsp;<img id="modal_spinner" src="',MB.constant.base_url,'img/spinner.gif" style="visibility: hidden"></div>','<input type="hidden" value="',MB.constant.token,'" name="',MB.constant.token_name,'" />',"</form>")},cb:function(f){f.child("div.mbButton").addClassOnOver("mbButtonOver");f.child("input[name=account_search]").focus();var g=MB.constant.base_control+"campaigns/"+f.child("input[name=campaign_id]").getValue()+"/ajax_view";Ext.Ajax.request({url:g,success:function(j){var h=Ext.decode(j.responseText);var k=[];if(h.length){var i=0;k.push({tag:"li",html:'<input type="checkbox" checked="checked" id="copy_all_ad_groups"> <label for="copy_all_ad_groups">'+_("Select All")+"</label>"});Ext.each(h,function(l){i+=parseInt(l.count);k.push({tag:"li",cls:"sub",html:'<input type="checkbox" class="adgroup_checkbox" checked="checked" name="ad_group_id[]" rel="'+l.count+'" value="'+l.ext_id+'" id="ad_group_id_'+l.ext_id+'"> <label class="adgroup" for="ad_group_id_'+l.ext_id+'">'+l.name+' <span class="ad_group_ad_count" style="display:none; color:gray;">('+l.count+" creatives)</span></label><br>"})});Ext.DomHelper.overwrite("copy-advanced-details",[{tag:"ul",cls:"copyOptions",children:k}]);Ext.get("copy-advanced-details").insertHtml("beforeEnd",'<br><input type="checkbox" name="copy_all_ads"  value="1" id="copy_all_ads" class="adgroup_checkbox"> <label class="ad" for="copy_all_ads">'+_("Copy all ads for selected ad groups.")+'</label> <span id="creativecount_message" style="display:none; color:gray;">You can copy up to '+remaining_creatives+" total creative(s).</span>");Ext.select("input[name*=ad_group_id]").on("click",function(){Ext.get("copy_all_ad_groups").dom.checked=false});Ext.get("copy_all_ad_groups").on("click",function(m,l){Ext.each(Ext.query("input[name*=ad_group_id]"),function(n){n.checked=l.checked})});if(i>remaining_creatives){Ext.get("creativecount_message").show();Ext.each(Ext.query(".ad_group_ad_count"),function(l){Ext.get(l).show()});Ext.each(Ext.query(".adgroup_checkbox"),function(l){l=Ext.get(l);l.on("click",function(o,p,m){var n=0;Ext.each(Ext.query(".adgroup_checkbox:checked"),function(q){n+=parseInt(q.getAttribute("rel"))});if(n>remaining_creatives){Ext.get("copy_all_ads").dom.disabled=true;Ext.get("copy_all_ads").dom.checked=false}else{Ext.get("copy_all_ads").dom.disabled=false}})})}}else{Ext.DomHelper.overwrite("copy-advanced-details",[_("No Ad Groups found")])}}});Ext.select(".accountSearch button").on("click",function(j){j.stopEvent();var i=f.child(".accountSearch input").getValue();var h=MB.constant.base_control+"campaigns/search/account_search/";Ext.Ajax.request({url:h,params:{q:i},success:function(k){var l=Ext.decode(k.responseText);if(l.id){f.child("#target_user_id").dom.value=l.id;f.child(".accountLock span").update(i);f.child(".accountLock").show();f.child(".accountSearchError").setDisplayed("none");f.child(".accountSearch").setDisplayed("none");f.child(".restForm").show();f.child("input[name=submit]").dom.disabled=false;MB.Modal.resize()}else{f.child(".accountSearchError").show()}}})})}},ad_group_copy:{tpl:function(){return new Ext.XTemplate('<h2 style="margin-top: 0"  class="adgroup titleUnderline">',_("Copy Ad Group:")," {name}</h2> ",'<form action="',MB.constant.base_control,"campaigns/",campaign_id,'/action/copy_ad_group" method="POST">','<input type="hidden" name="ad_group_id" value="{ext_id}">',"<p>",_("To copying an existing ad group, enter a <b>New Ad Group Name</b> then select which <b>Ads to Copy</b>. Optionally, select a different <b>destination</b> campaign."),"</p><br><b>",_("New Ad Group Name"),':</b> <input type="text" value="{copy_name}" size="50" name="name">','<div class="x-clear"></div><p style="float: left; padding: 10px 5px 10px 0"><b>',_("Destination:"),"</b></p>",'<p style="float: left;  padding: 10px 0"><input type="radio" name="target" value="',campaign_id,'" id="new_target" checked="checked"> ','<label class="campaign" for="new_target">',_("Current Campaign"),"</label><br>",'<input type="radio" name="target" value="existing" id="existing_target"> ','<span class="other_campaign_option">','<label class="campaign" for="existing_target">',_("Other Campaign:"),"</label>",'&nbsp;<span id="existing_target_span">','<select disabled="disabled"><option>',_("Loading..."),"</option></select>","</span></span></p>",'<div class="x-clear"></div><b>',_("Ads to Copy:"),'</b><div class="copyAdvancedDetails moduleTiny" id="copy-advanced-details">','<input type="hidden" name="deep_copy_ads" value="1">','<img src="',MB.constant.base_url,'img/spinner.gif" />',"</div>",'<span id="remaining_message" style="display:none;">',_("You may select up to %d creative to copy because of the number of active creatives in your account","You may select up to %d creatives to copy because of the number of active creatives in your account",Math.max(remaining_creatives,0)),"</span>","<div class='moduleTiny' style='text-align: center'><div class='mbButton'>","<input type='submit' value='",_("Copy Ad Group")," &raquo;' id='submit' name='submit'/></div>","&nbsp;&nbsp;&nbsp;&nbsp;<a href='#' id='cancel_link'>",_("cancel"),'</a>&nbsp;<img id="modal_spinner" src="',MB.constant.base_url,'img/spinner.gif" style="visibility: hidden"></div>','<input type="hidden" value="',MB.constant.token,'" name="',MB.constant.token_name,'" />',"</form>")},cb:function(f){f.child("input[name=name]").focus();var g=function(){if(Ext.get("new_target").dom.checked){Ext.get("existing_target_id").set({disabled:"disabled"},false)}else{Ext.get("existing_target_id").set({disabled:""},false)}};Ext.get("new_target").on("change",g);Ext.get("existing_target").on("change",g);Ext.Ajax.request({url:MB.constant.base_control+"campaigns/view/ajax_view",method:"GET",params:{id:campaign_id},success:function(k){var i=Ext.decode(k.responseText);var j=[];Ext.each(i,function(l){if(l.ext_id!=campaign_id){j.push({tag:"option",value:l.ext_id,html:l.name})}});if(j.length==0){j.push({tag:"option",value:"",html:_("No applicable Campaigns found.")});f.select(".other_campaign_option label").addClass("disabled");Ext.get("existing_target").dom.disabled=true;Ext.get("new_target").dom.checked=true}Ext.DomHelper.overwrite("existing_target_span",{tag:"select",name:"existing_target_id",id:"existing_target_id",children:j});g()}});f.child("div.mbButton").addClassOnOver("mbButtonOver");var h=MB.constant.base_control+"ad_groups/"+f.child("input[name=ad_group_id]").getValue()+"/ajax_view";Ext.Ajax.request({url:h,success:function(k){var j=Ext.decode(k.responseText);var l=[];if(j.length){var i=true;if(j.length>parseInt(remaining_creatives)){Ext.get("remaining_message").show();i=false}l.push({tag:"li",html:'<input type="checkbox" id="copy_all_ads"'+(i?' checked="checked"':'disabled="disabled"')+'>&nbsp;<label for="copy_all_ads">'+_("Select All")+"</label>"});Ext.each(j,function(n){l.push({tag:"li",cls:"sub",html:'<input type="checkbox" class="creative_checkbox" name="ad_id[]"'+(i?' checked="checked"':"")+' value="'+n.ext_id+'" id="ad_id_'+n.ext_id+'"> <label class="ad" for="ad_id_'+n.ext_id+'">'+n.name+"</label><br>"})});Ext.DomHelper.overwrite("copy-advanced-details",[{tag:"ul",cls:"copyOptions",children:l}]);if(j.length>parseInt(remaining_creatives)){var m=function(p,o,n){if(Ext.query(".creative_checkbox:checked").length>=parseInt(remaining_creatives)){Ext.each(Ext.query(".creative_checkbox:not(:checked)"),function(q){q.disabled=true})}else{Ext.each(Ext.query(".creative_checkbox:not(:checked)"),function(q){q.disabled=false})}};Ext.each(Ext.query(".creative_checkbox"),function(n){n=Ext.get(n);n.on("click",m)});m()}}if(l.length>0){Ext.get("copy_all_ads").on("click",function(o,n){Ext.each(Ext.query("input[name*=ad_id]"),function(p){p.checked=n.checked})});Ext.select("input[name*=ad_id]").on("click",function(){Ext.get("copy_all_ads").dom.checked=false})}else{Ext.DomHelper.overwrite("copy-advanced-details",[_("No ads found")])}}})}},creative_copy:{tpl:function(){return new Ext.XTemplate('<h2 style="margin-top: 0" class="ad titleUnderline">',_("Copy Ad:")," {name}</h2> ",'<form action="',MB.constant.base_control,"ad_groups/",ad_group_id,'/action/copy_ad" method="POST">','<input type="hidden" name="ad_id" value="{ext_id}">',"<p>",_("To copy an existing ad, enter a <b>New Ad Name</b>. Optionally, select a different <b>Destination</b> ad group. An ad can only be copied to an ad group with the same <b>Ad Goal</b>."),"</p><br><b>",_("New Ad Name: "),'</b><input type="text" value="{copy_name}" size="50" name="name">',"<br/><br/>","<b>",_("Destination:"),"</b>","<ul>","<li>",'<input type="radio" name="target" value="',ad_group_id,'" id="new_target" checked="checked"> ','<label for="new_target">',_("Current Ad Group"),"</label>","</li>",'<li class="other_ad_group_option">','<input type="radio" name="target" value="existing" id="existing_target"> ','<label for="existing_target">',_("Other Ad Group:"),"</label>",'&nbsp;<span id="existing_target_span"><select disabled="disabled">',"<option>",_("Loading..."),"</option></select></span>","</li>","</ul><div class='moduleTiny' style='text-align: center'>","<div class='mbButton'><input type='submit' value='",_("Copy Ad")," &raquo;' id='submit' name='submit'/></div>","&nbsp;&nbsp;&nbsp;&nbsp;<a href='#' id='cancel_link'>",_("cancel"),'</a>&nbsp;<img id="modal_spinner" src="',MB.constant.base_url,'img/spinner.gif" style="visibility: hidden"></div>','<input type="hidden" value="',MB.constant.token,'" name="',MB.constant.token_name,'" />',"</form>")},cb:function(f){f.child("input[name=name]").focus();var g=function(){if(Ext.get("new_target").dom.checked){Ext.get("existing_target_id").set({disabled:"disabled"},false)}else{Ext.get("existing_target_id").set({disabled:""},false)}};Ext.get("new_target").on("change",g);Ext.get("existing_target").on("change",g);var h=MB.constant.base_control+"campaigns/"+campaign_id+"/ajax_view_similar";Ext.Ajax.request({url:h,method:"GET",params:{id:ad_group_id},success:function(k){f.select("img.spinner").setStyle("display","none");var i=Ext.decode(k.responseText);var j=[];Ext.each(i,function(l){if(l.ext_id!=ad_group_id){j.push({tag:"option",value:l.ext_id,html:l.name})}});if(j.length==0){j.push({tag:"option",value:"",html:_("No applicable Ad Groups found.")});f.select(".other_ad_group_option label").addClass("disabled");Ext.get("existing_target").dom.disabled=true;Ext.get("new_target").dom.checked=true}Ext.DomHelper.overwrite("existing_target_span",{tag:"select",name:"existing_target_id",id:"existing_target_id",children:j});g()}});f.child("div.mbButton").addClassOnOver("mbButtonOver")}}};var d=function(g,f){var g=Ext.get(g);if(f){g.child("div.tools").show()}else{g.child("div.tools").hide()}};var c=function(){if(Ext.query("table.altRowTable td.tableRowCheck input:checked").length>0){b.removeClass("mbButtonDisabled")}else{b.addClass("mbButtonDisabled")}};var a=false;return{init:function(){b=Ext.select("span[class*=Action]");c();if(Ext.isIE6){Ext.select("tr.tableRow").on({mouseover:function(j,i){if(!j.within(this,true)){d(this,true);Ext.get(this).addClass("tableRowHover")}},mouseout:function(j,i){if(!j.within(this,true)){d(this,false);Ext.get(this).removeClass("tableRowHover")}}})}Ext.select("a.copy").on("click",function(k,i){k.stopEvent();if(!Ext.get(i).hasClass("disabled")){var j=i.getAttribute("rel")||Ext.get(i).parent("a").dom.getAttribute("rel");var m=Ext.get(i).parent("tr");var l={name:m.child(".name").dom.innerHTML,copy_name:m.child(".name").dom.innerHTML+" copy",ext_id:m.dom.getAttribute("rel")};MB.Modal.init();MB.Modal.show({content:e[j].tpl().apply(l),close_el:"cancel_link",show_callback:e[j].cb,size:"large"})}});if(Ext.get("quick_date_link")){var g=new Date();g.setDate(g.getDate()-190);var f={renderTo:"quick_date_link",showSubmitButton:true,resetOnClose:true,dateFormat:"Y/m/d",rangePrefix:"",rangeSeparator:" - ",alignMode:"tr-br?",minDate:g,onSubmit:function(k,i){k.stopEvent();var j=Ext.get("date_range_form").dom;j.start_date.value=this.current_values.start_date.format("Y-m-d");j.end_date.value=this.current_values.end_date.format("Y-m-d");j.submit()}};if(start_date){f.values={start_date:start_date.split(" ")[0],end_date:end_date.split(" ")[0]}}var h=new MB.ext.DateRange(f)}Ext.select("table.altRowTable tbody input, table.altRowTable thead input").on("click",c,this);b.on("click",function(k,i){k.stopEvent();i.blur();if(Ext.get(i).is("span.mbButton")){i=Ext.get(i).first().dom}if(!Ext.get(i).parent("span").hasClass("mbButtonDisabled")){var j=i.className.match(/([^_]+)Action/)[1];Ext.select("span[class*=Action]").addClass("mbButtonDisabled");if(j=="delete"){MB.Modal.init();MB.Modal.show({content:_("Are you sure you want to delete?"),confirmation:{confirm_txt:_("Delete"),confirm_callback:function(l){i.form.action+="delete";i.form.submit()},cancel_callback:function(l){Ext.select("span[class*=Action]").removeClass("mbButtonDisabled")}}});k.stopEvent()}else{if(i.form.action.match(/action\/$/)){i.form.action+=j;Ext.select("span[class*=Action]").addClass("mbButtonDisabled");i.form.submit()}}}});if(typeof(highlight_row)!="undefined"){Ext.select("tr[rel="+highlight_row+"]").highlight()}Ext.select("a.bidChange").on("click",function(m,j){m.stopEvent();var l=Ext.get(j).parent("tr");var n=l.dom.getAttribute("rel");var i=function(o){if(typeof ad_group_id!="undefined"){var p=MB.constant.base_control+"ad_groups/"+ad_group_id+"/action/get_min_bid"}else{var p=MB.constant.base_control+"campaigns/"+campaign_id+"/action/get_min_bid"}paramsObj={id:n};paramsObj[MB.constant.token_name]=MB.constant.token;Ext.Ajax.request({url:p,params:paramsObj,success:function(s){var q=Ext.decode(s.responseText);o.child("span.minBid img").remove();o.child("span.minBid span").update(q.min_bid)}});return};var k=l.child("span.originalBid").dom.innerHTML;MB.Modal.init();MB.Modal.show({content:['<div class="errorDiv" style="display: none; margin: 5px 0;"></div>','Enter a new bid: <input type="text" size="5" align="right" value="',k,'">','<span class="minBid" style="color:#777; font-style:italic">&nbsp;&nbsp;Min bid: $<img src="',MB.constant.base_url,'img/spinner.gif"><span></span></span>'].join(""),show_callback:i,confirmation:{confirm_txt:_("Set New Bid"),confirm_callback:function(s,r,u){s.stopEvent();var p=u.m_window;if(typeof ad_group_id!="undefined"){var q=MB.constant.base_control+"ad_groups/"+ad_group_id+"/action/change_bid"}else{var q=MB.constant.base_control+"campaigns/"+campaign_id+"/action/change_bid"}paramsObj={bid:p.child("input").getValue(),id:n};paramsObj[MB.constant.token_name]=MB.constant.token;Ext.Ajax.request({url:q,params:paramsObj,success:function(t){var o=Ext.decode(t.responseText);if(o.error){p.child("div.errorDiv").update(o.error).show();MB.Modal.resetConfirm()}else{if(o.bid){l.child("a.bidChange").update('$<span class="originalBid">'+o.bid+"</span>").highlight();MB.Modal.hide()}}}})},title:(typeof ad_group_id!="undefined"?_("Change Bid for Ad: "):_("Change Bid for Ad Group: "))+l.child(".name").dom.innerHTML}})});MB.campaign.preview.init()},enableHouseAds:function(f){if(typeof f=="undefined"){f=true}a=f},get_stats:function(h,f){var g=[];Ext.each(Ext.query("tr[rel]"),function(j){g.push(j.getAttribute("rel"))});var i=Ext.Ajax.request({url:MB.constant.base_control+f,params:{"ids[]":g},success:function(j){var n=Ext.decode(j.responseText);if(n.error){Ext.get(Ext.query("table.altRowTable td.statsFirst")[0]).update(n.msg);Ext.select("table.altRowTable td.totalRowStatsFirst").update("&nbsp;");return}for(var k in n.s){var q=[];for(var o=1,p=n.s[k].length;o<p;o++){var m;if(a&&o===p-1){var l=Ext.select("table.altRowTable tr[rel="+k+"] td.statsFirst").item(0).prev().dom.textContent.replace(/[^0-9\.]/g,"");if(l!==""){l=parseInt(l.replace(/[^0-9\.]/g,""),10)}var s=parseInt(n.s[k][0].replace(/[^0-9\.]/g,""),10);if(l===0){m="0.00%"}else{if(l===""){m=_("N/A")}else{m=MB.util.formatNumber(s/l*100,{precision:2})+"%"}}}else{m=n.s[k][o]}q.push({tag:"td",align:"right",html:m})}Ext.select("table.altRowTable tr[rel="+k+"] td.statsFirst").set({align:"right",colSpan:1}).insertSibling(q,"after").update(n.s[k][0])}var q=[];for(var o=1;o<n.t.length;o++){q.push({tag:"td",align:"right",html:n.t[o]})}if(a){q.push({tag:"td",align:"right",html:"-"})}q[0].cls="totalRowLast";Ext.select("table.altRowTable td.totalRowStatsFirst").set({align:"right",colSpan:1}).insertSibling(q,"after").update(n.t[0]).removeClass("totalRowLast")},failure:function(j){if(j.status===-1){Ext.get(Ext.query("table.altRowTable td.statsFirst")[0]).update(_("Oops, looks like something went wrong. Please refresh to try again."));Ext.select("table.altRowTable td.totalRowStatsFirst").update("&nbsp;")}},timeout:120000});(function(){if(Ext.Ajax.isLoading(i)){Ext.select("table.altRowTable td.statsFirst img").insertHtml("afterEnd","<br>"+_("Still working on it ..."))}}).defer(20000)}}}();MB.campaign.preview=function(){var a=false;var f=MB.constant.base_control+"ajax/ad_preview/";var c=false;var b=new Ext.XTemplate('<div class="objectPreviewPanel">','<tpl if="cp">','<div class="campaignPreviewPanel">',"{cp}","</div>","</tpl>",'<tpl if="gp">','<div class="adGroupPreviewPanel">',"{gp}","</div>","</tpl>",'<tpl if="ap">','<div class="creativePreviewPanel">',"{ap}","</div>","</tpl>","</div>");var d=new Ext.XTemplate('<div class="ppHeader"><h2>',_("Campaign Summary"),"</h2></div>",'<div class="ppBodyHead"></div>','<div class="ppBody">',"<div><label>",_("Name"),"</label> <p>{[fm.htmlEncode(values.name)]}</p></div>","<hr>","<div><label>",_("Date"),'</label> <p>{[fm.htmlEncode(values.start_date)]} <tpl if="end_date"> -<br> {[fm.htmlEncode(values.end_date)]}</tpl></p></div>','<tpl if="budget">',"<hr>","<div><label>",_("Budget"),"</label> <p>{[fm.usMoney(values.budget)]}</p></div>","</tpl>",'<tpl if="budget_style">',"<hr>","<div><label>",_("Delivery Method"),"</label> <p>{budget_style}</p></div>","</tpl>",'<tpl if="io_number">',"<hr>","<div><label>","IO Number","</label> <p>{[fm.htmlEncode(values.io_number)]}</p></div>","</tpl>",'<div class="clear"></div>',"</div>");var e=new Ext.XTemplate('<div class="ppHeader"><h2>',_("Ad Group Summary"),"</h2></div>",'<div class="ppBodyHead"></div>','<div class="ppBody">',"<div><label>",_("Name"),"</label> <p>{[fm.htmlEncode(values.name)]}</p></div>","<hr>","<div><label>",_("Type"),"</label> <p>{type}</p></div>",'<tpl if="start_date">',"<hr>","<div><label>","Date","</label> <p>{[fm.htmlEncode(values.start_date)]}",'<tpl if="end_date">'," -<br> {[fm.htmlEncode(values.end_date)]}","</tpl>","</p></div>","</tpl>",'<tpl if="cpm">',"<hr>","<div><label>","Budget Summary","</label> <p>{[this.budget(values)]}</p></div>","</tpl>",'<tpl if="platform">',"<hr>","<div><label>",_("Platform / Device"),"</label></div>","<hr>","<p>{platform}</p>","</tpl>",'<tpl if="geo">',"<div><label>",_("Geography / Operators"),"</label></div>","<hr>","<p>{geo}</p>","</tpl>",'<tpl if="demo">',"<div><label>",_("Demographics"),"</label></div>","<hr>","<p>{demo}</p>","</tpl>",'<tpl if="full_serve">',"<hr>","<div><label>",_("Full Serve"),"</label></div>","<hr>","<p>{full_serve}</p>","</tpl>",'<tpl if="min_bid">','<span id="preview_min_bid_section">',"<hr>","<div><label>",_("Min Bid"),"</label>",'<p><span id="preview_min_bid">{min_bid}</span></p></div>',"</span>","</tpl>",'<div class="clear"></div>',"</div>",{budget:function(h){if(isNaN(h.impressions)||isNaN(h.cpm)||isNaN(h.cpm)){return""}return MB.util.formatInt(h.impressions)+"; "+Ext.util.Format.usMoney(h.cpm)+"; "+Ext.util.Format.usMoney(h.impressions/1000*h.cpm)}});var g=new Ext.XTemplate('<div class="ppHeader"><h2>',_("Ad Summary"),"</h2></div>",'<div class="ppBodyHead"></div>','<div class="ppBody">',"<div><label>",_("Name"),"</label> <p>{[fm.htmlEncode(values.name)]}</p></div>",'<tpl if="text">',"<hr>","<div><label>",_("Text"),"</label> <p>{[fm.htmlEncode(values.text)]}</p></div>","</tpl>",'<tpl if="url">',"<hr>","<div><label>",_("URL"),"</label> <p>{[this.url(values.url)]}</p></div>","</tpl>",'<tpl if="app">',"<hr>","<div><label>",_("App"),"</label> <p>{app}</p></div>","</tpl>",'<tpl if="this.len(bids)">',"<hr>","<div><label>",_("Bid"),"</label> <p>{[this.bids(values.bids)]}</p></div>","</tpl>",'<tpl if="this.len(images)">',"<hr>","<div>",'<tpl for="images">',"<img src={.}><br>","</tpl>","</div>","</tpl>",'<div class="clear"></div>',"</div>",{url:function(h){var i=encodeURI((/.*:\/\/.*/.test(h)?h:"http://"+h));return'<a target="_blank" alt="'+i+'" href="'+i+'">'+Ext.util.Format.ellipsis(Ext.util.Format.htmlEncode(h),35)+"</a>"},len:function(h){return(h.length>0)},bids:function(k){if(k.length==0){return""}var h=Array.max(k),j=Array.min(k),i="";if(j!=h){i+=Ext.util.Format.usMoney(j)+" - "+Ext.util.Format.usMoney(h)}else{i+=Ext.util.Format.usMoney(j)}i+=" ("+_("%1 channel","%1 channels",k.length)+")";return i}});return{init:function(){if(a){return true}a=true;Ext.select(".objectPreview").on("click",this.get,this)},get:function(m,l){m.stopEvent();l.blur();l=Ext.get(l).hasClass("objectPreview")?l:Ext.get(l).parent(".objectPreview").dom;var i=MB.PopUp.showPopUp(l,'<div align="center"><img style="padding: 10px" src="'+MB.constant.base_url+'img/spinner.gif"></div>',null,{position:"right",size:"medium"});i.child(".mediumPopUpTop").addClass("popupGray");i.child(".mediumPopUpBottom").addClass("popupGray");Ext.get("popup-arrow").addClass("popUpArrowRightGray");var h=l.getAttribute("rel").split("|"),j=h[0],n=h[1],k=f+j;Ext.Ajax.request({url:k,params:{id:n},scope:this,success:function(o){var p=Ext.decode(o.responseText);if(p.error){Ext.get("popup-body").update(_("Oops... something went wrong :("));MB.PopUp.redraw(true);return false}this.render(p,Ext.get("popup-body"),true);MB.PopUp.redraw(true)}})},render:function(o,k,n){if(o.campaign){o.campaign.name=o.campaign.name.trim();o.campaign.budget=o.campaign.budget||"";o.campaign.budget_style=o.campaign.budget_style||"";o.campaign.io_number=o.campaign.io_number||""}if(o.ad_group){o.ad_group.name=o.ad_group.name.trim();var m=["geo","platform","demo","full_serve","cpm","start_date","end_date","impressions","min_bid"];for(var j=0,h=m.length;j<h;j++){o.ad_group[m[j]]=o.ad_group[m[j]]||""}}if(o.creative){o.creative.name=o.creative.name.trim();o.creative.text=o.creative.text||"";if(o.creative.text=="CPM"){o.creative.text=_("None")}o.creative.bids=o.creative.bids||[];o.creative.images=o.creative.images||[];o.creative.url=o.creative.url||"";o.creative.app=o.creative.app||""}k.update(b.apply({cp:o.campaign?d.apply(o.campaign):null,gp:o.ad_group?e.apply(o.ad_group):null,ap:o.creative?g.apply(o.creative):null}));if(n){k.select("div.ppHeader").on("click",function(l,i){var i=Ext.get(i).hasClass("ppHeader")?Ext.get(i):Ext.get(i).parent("div.ppHeader");if(i.hasClass("ppHeaderClosed")){i.next(".ppBodyHead").setStyle("display","");i.next(".ppBody").setStyle("display","")}else{i.next(".ppBodyHead").setStyle("display","none");i.next(".ppBody").setStyle("display","none")}i.toggleClass("ppHeaderClosed");MB.PopUp.redraw(true)})}else{k.select("div.ppHeader").removeClass("ppHeader");k.select(".objectPreviewPanel h2").setStyle("padding-left","0")}}}}();MB.campaign.bidInfo=function(){return{show:function(b,a){if(Ext.get("min_bid_help_tip")){Ext.get("min_bid_help_tip").remove()}var c="<b>Winning bid rule: "+b.winner.id+"</b>";if(b.winner.rule_type=="override"){c+=" (discount)"}else{if(b.winner.rule_type=="user"){c+=" (user override)"}}c+="<br><br>";if(b.winner.conditions.length){c+="Conditions:<br><ul style='margin-left:15px;list-style-type:disc'>";Ext.each(b.winner.conditions,function(d){c+="<li>";if(d[0]=="special"){c+=d[1]}else{if(d[0]===null){c+="some targeting"}else{c+=d[0]}}if(d[2]){c+=" must be "}else{c+=" must not be "}if(d[0]=="special"){c+="true"}else{if(d[1]!==null){c+=d[1]}else{c+="set"}}c+="</li>"});c+="</ul><br>"}c+="Base bid: <b>"+b.winner.minimum_bid;if(b.winner.minimum_bid>1){c+=" cents</b><br>"}else{c+=" cent</b><br>"}if(b.winner.targeting_fee_max!=0){if(b.winner.targeting_fee_min==b.winner.targeting_fee_max){c+="Targeting fee: <b>"+b.winner.targeting_fee_max}else{c+="Targeting fee range: <b>"+b.winner.targeting_fee_min+" - "+b.winner.targeting_fee_max}if(b.winner.targeting_fee_max>1){c+=" cents</b><br>"}else{c+=" cent</b><br>"}}if(b.device_fee){c+="Fee: <b>1 cent</b> due to device targeting<br>"}if(typeof b.ratio!=="undefined"){c+="Traffic ratio: ";c+=b.fee_numerator+"&nbsp;/&nbsp;"+b.fee_denominator+"&nbsp;=&nbsp;<b>"+b.ratio.toFixed(3)+"</b><br>"}if(b.matches.length>1){c+="<br>Eligible rules: <b>"+b.matches.join("</b>, <b>")+"</b><br>"}Ext.DomHelper.insertAfter(a,{tag:"img",cls:"helpTip onHover",src:MB.constant.base_url+"img/icons/help.png",id:"min_bid_help_tip",alt:c});MB.helpTip.enableForElement("min_bid_help_tip")}}}();